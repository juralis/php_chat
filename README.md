# php_chat

Это что-то вроде дневника-журнала изучения/разработки. В идеале, по нему можно воспроизвести порядок действий и получить примерно аналогичный результат. Это сделано чтобы "дурь каждого видна была" (с). Иными словами, демонстрация действий, чтобы по ней можно было что-то понять о том, что и почему сделано.

## Установка окружения

### Ставим nginx

Дистрибутив debian-based. (Какой-то Netruner - впервые слышу)

```
sudo nano /etc/apt/sources.list
```
Добавляем туда:

```
deb http://ftp.debian.org/debian/ testing main contrib non-free
deb-src http://ftp.debian.org/debian/ testing main contrib non-free
```
`ctrl+x`, `y`

```
sudo nano /etc/apt/preferences
```
Туда вписываем:

```
Package: nginx
Pin: release a=testing
Pin-Priority: 900
```
`ctrl+x`, `y`  
Далее:

```
sudo apt-get update
sudo apt-cache policy nginx
sudo apt-get install nginx
```
Nginx установлен. Потом с конфигом разберёмся.

### Postgresql

По мотивам: https://amkolomna.ru/content/ustanovka-i-nastroyka-servera-postgresql-pod-linux-ubuntu   
(хз, что тут вообще делается. Вступаю на скользкую дорожку)  

```
sudo apt-get install postgresql
sudo passwd -d postgres
sudo su postgres  -c passwd
psql -d postgres
ALTER USER postgres WITH PASSWORD '123456'
```
`123456` - даже не знаю, стоит ли оправдываться?

\+ поставил jetbrains datagrip какие-то там драйверы и вот это всё, подключился - вроде норм.

Конечно, после монги `ВЕСЬ ЭТОТ SQL синтаксис выглядит ВЕСЬМА себе (странно);`

```SQL
CREATE DATABASE php_chat;
```
(Пока вроде просто)

```SQL
CREATE TABLE users
(
    login TEXT NOT NULL,
    pass TEXT NOT NULL,
    name TEXT NOT NULL,
    ts TIMESTAMP,
    last_visit INT
);
CREATE UNIQUE INDEX users_login_uindex ON users (login);
```
Не люблю когда неизвестные в общем-то вещи - понятны. Где-то тут должно быть место для выстрела в ногу  
Вот с этого момента ощущается уже какая-то неуверенность. Вроде вышеуказанный скрипт сработал, а в датагрипе ничего не видать. Но и повторно всабачить таблицу не даёт - вестимо уже существует.  

``` 
CREATE TABLE chat_log
(
    author_id INT NOT NULL,
    text TEXT NOT NULL,
    time INT NOT NULL
);
```

Ну, как-то так. Вообще, не оченьмне нравится все эти дела с author_id. Лучше бы прямо там имя пользователя хранить. И не суть даже, что это считается не кошерным, зато выгребать удобнее было бы. А теперь придётся по каждому сообщению сопоставлять пользователя чтоли? А как?

Ладно, пробуем вставить в табличку какие-то данные

```SQL
INSERT INTO users (
  login,
  pass,
  name,
  ts,
  last_visit
) VALUES (
  'test1',
  'q1w2e3r4t5y6', --Кстати, а как там хэш в пхп считать?
  'Христофор',
  '2014-04-04 20:00:00-07', -- Это у них называется timestamp?
  0
)
```
тааак...
```SQL
SELECT * FROM users WHERE login = 'test1';
```
Выдало что-то такое вот:
```
test1	q1w2e3r4t5y6	Христофор	2014-04-04 20:00:00.000000	0
```
Жить можно - эта штука может всасывать и отдавать данные. В принципе, больше ничего от неё и не требовалось.  
А вот это всё надо как-то шаблонить типа? Всегда меня SQL смущал именно тем, что это отдельный язык, который никак не интегрируется в используемый. В той же монге я бы это просто так сделал:
```javascript
db.chat.users.findOne({login: 'test1'})
```
Как-то оно более объектно выходит. А тут...

Ладно. Что там с пхп.

### PHP

Значит, для вебсокетов нашел вот это: http://socketo.me/docs/hello-world
Работает в целом.
На итог, вышла такая вот струтура проэкта:
```
root-|
     |
     |-bin/app.php
     |-src/CoolChat/Events.php
     |-vendor/...
     |-composer.json
     |-composer.lock
     |-composer.phar
     _
```
Ещё сюда надо будет загнать html+css+js. И картиночки.
В общем, в гит залью будет видно.
Приятно, что json кушает прямо из коробки. Или тут не принято использовать встроенный json-сериализатор?

... Спустя какое-то время ...

Удалось всё запустить, сообщение из одной вкладки успешно расходится по остальным. Через нгинкс, со всеми делами.
Осталось сложить это в базузу, добавить регистрацию/авторизацию и склепать под это какой-нибудь удобоваримый интерфейс. Можно пойти покурить и подумать над варнишем
