# php_chat

Это что-то вроде дневника-журнала изучения/разработки. В идеале, по нему можно воспроизвести порядок действий и получить примерно аналогичный результат. Это сделано чтобы "дурь каждого видна была" (с). Иными словами, демонстрация действий, чтобы по ней можно было что-то понять о том, что и почему сделано.

## Установка окружения

### Ставим nginx

Дистрибутив debian-based. (Какой-то Netruner - впервые слышу)

```
sudo nano /etc/apt/sources.list
```
Добавляем туда:

```
deb http://ftp.debian.org/debian/ testing main contrib non-free
deb-src http://ftp.debian.org/debian/ testing main contrib non-free
```
`ctrl+x`, `y`

```
sudo nano /etc/apt/preferences
```
Туда вписываем:

```
Package: nginx
Pin: release a=testing
Pin-Priority: 900
```
`ctrl+x`, `y`  
Далее:

```
sudo apt-get update
sudo apt-cache policy nginx
sudo apt-get install nginx
```
Nginx установлен. Потом с конфигом разберёмся.

### Postgresql

По мотивам: https://amkolomna.ru/content/ustanovka-i-nastroyka-servera-postgresql-pod-linux-ubuntu   
(хз, что тут вообще делается. Вступаю на скользкую дорожку)  

```
sudo apt-get install postgresql
sudo passwd -d postgres
sudo su postgres  -c passwd
psql -d postgres
ALTER USER postgres WITH PASSWORD '123456'
```
`123456` - даже не знаю, стоит ли оправдываться?

\+ поставил jetbrains datagrip какие-то там драйверы и вот это всё, подключился - вроде норм.

Конечно, после монги `ВЕСЬ ЭТОТ SQL синтаксис выглядит ВЕСЬМА себе (странно);`

```SQL
CREATE DATABASE php_chat;
```
(Пока вроде просто)

```SQL
CREATE TABLE users
(
    login TEXT NOT NULL,
    pass TEXT NOT NULL,
    name TEXT NOT NULL
);
CREATE UNIQUE INDEX users_login_uindex ON users (login);
```
Не люблю когда неизвестные в общем-то вещи - понятны. Где-то тут должно быть место для выстрела в ногу  

```SQL 
CREATE TABLE chat_log
(
    login TEXT NOT NULL,
    text TEXT NOT NULL,
    time INT NOT NULL
);
```

Ну, как-то так. Потом подправлю ежели чего.

Ладно, пробуем вставить в табличку какие-то данные

```SQL
INSERT INTO users (
  login,
  pass,
  name
) VALUES (
  'test1',
  'q1w2e3r4t5y6',
  'Христофор',
)
```
тааак...
```SQL
SELECT * FROM users WHERE login = 'test1';
```
Выдало что-то такое вот:
```
test1	q1w2e3r4t5y6	Христофор
```
Жить можно - эта штука может всасывать и отдавать данные. В принципе, больше ничего от неё и не требовалось.  
А из кода это как вызывать? Шаблонизировать как-то? Всегда меня SQL смущал именно тем, что это отдельный язык, который никак не интегрируется в используемый. В той же монге я бы это просто так сделал:
```javascript
db.chat.users.findOne({login: 'test1'})
```
Как-то оно более объектно выходит. А тут...

Ладно. Что там с пхп.

### PHP

Значит, для вебсокетов нашел вот это: http://socketo.me/docs/hello-world
Работает в целом.
На итог, вышла такая вот струтура проэкта:
```
root-|
     |-application/...
     |-bin/app.php
     |-static-|
     |        |-css/...
     |        |-js/...
     |        |-img/...
     |        |-index.html
     |        _
     |-src/CoolChat/Events.php
     |-system/...     
     |-vendor/...
     |-composer.json
     |-composer.lock
     |-composer.phar
     |-.gitignore
     |-index.php
     _
```
(примечание) Приятно, что json кушает прямо из коробки. Или тут не принято использовать встроенный json-сериализатор?  

... Спустя какое-то время ...  

Удалось всё запустить, сообщение из одной вкладки успешно расходится по остальным. Через нгинкс, со всеми делами.
Осталось сложить это в базу, добавить регистрацию/авторизацию и склепать под это какой-нибудь удобоваримый интерфейс. Можно пойти покурить и подумать над варнишем  

... ещё спустя некоторое время ...  

Не окончено. В принципе, можно с некоторой натяжкой говорить о том, что я многое понял сегодня и костяк приложения готов (по крайней мере, понятно, что оно будет работать как оно будет работать).  


### Последок.

Вроде всё это как-то аскетично работает. Делаю публичную версию, если так можно выразиться. Всё вышеозначенное + варниш. Варнишь, варнишь...  

Нгинкс у меня уже стоял, постгрес поставил, как выше написано (там сейчас другие слегка таблички созданы, но в целом тоже самое).  

Код брать тут:  

`git clone https://github.com/juralis/php_chat.git`  

На всякой случай, прежде чем, надо вот:  

``` 
sudo apt-get install php-fpm 
sudo apt-get install php-pgsql
```

Там, кроме всего прочего, надо раскомментить в php.ini:
```
extension=php_openssl.dll
extension=php_pgsql.dll
extension=php_pdo_pgsql.dll
```
Чтобы крипта взлетела и постгрес. (примечание: а на другой машине их понадобилось напротив закоментить, так как он их пытался дважды импортировать. Странно, однако.)  

Конфиг для нгинкса лежит вместе с кодом приложения в папке configs (там внутри папка site-enabled, надо из неё взять файл и отправить в /etc/nginx/site-enabled/)

### varnish

Поскольку кроме статики и первой страницы тут кэшировать шибко нечего, все запросы, кроме регистрации и авторизации гоняются через вебсокеты и не кэшируются, то конфигурация варниша оказалась несколько скучной. Вообще, мне в принципе понятно, зачем может пригодиться кеширующий слой by Facebook, но в данном случае - он явно избыточен. Статику (которой и так почти нет) отлично может и нгинкс отдавать. Разве что главную закешировать. Ну, пусть будет. А в реальном приложении - там да, с учётом специфики Codeigniter, видимо без него будет не очень уютно.

```
sudo apt-get install varnish
```
С дефолтным конфигом, сразу запускается. Нужно только в файле  
/etc/varnish/default.vcl  
указать порт, на котором висит nginx (в нашем случае - 9999).  
В принципе, на этом всё.  
Можно открыть:  
http://digests.su:6081/  

И всё будет там.  

То есть, запрос попадает к варнишу, он его отправляет в нгинкс, тот дёргает php и всё как-то крутится.  

Впрочем, чтобы это заработало на полную катушку нужно сделать ещё одну мелоч.  

```
cd /path/to/project
php bin/app.php &
```
Теперь подняты вебсокеты и после регистрации и логина появится чат. В проде рекомендуют запускать это с помощью supervisord, но сущностно там тоже ничего интересного. Просто для контроля состояния.  

И так. В итоге, получилась такая вот штуковина:  
php-fpm висит на 7000 порту.  
вебсокеты висят на 8000 порту.  
nginx слушает 9999 порт.  
varnish слушает 6081.  

Вроде все в сборе.
