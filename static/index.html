<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ПХП-чат с вебсокетами как в лучших домах Ландона</title>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
</head>
<body>

<button id="send">Отправить</button>
<script>
    var ws = null;
    var ws_timer = null;
    var last_msg = null;

    var Methods = {
        chat_log: function(data){
            for (var i in data ){
                // append to log_window (reversed)
                console.log(data[i])
            }
        },
        new_msg: function(data){
            // append to log_window
            console.log(data)
        },
        sync: function(data){
            // если в наборе будет сообщение, которое уже есть в логе, тогда всё ок. Если нет, тогда надо поставить черту и кнопку подгрузки прошлых сообщений.
            for (var i in data ){
                // append to log_window (reversed)
                console.log(data[i])
            }
        },
        auth_res: function(data){
            set_cookie('token', data.token, 10);
            ws.push('get_log', {})
        },
        reg_res: function(data){
            set_cookie('token', data.token, 10)
        }
    };

    function ws_connect(){
        ws = new WebSocket('ws://localhost:8080/ws/');
        ws.onopen = function() {
            if(ws_timer){
                clearInterval(ws_timer);
                ws_timer = null;
            }
            if (last_msg) {
                ws.push('sync', {last_msg: last_msg})
            }
            console.log("ws-соединение установлено.");
        };

        ws.onmessage = function(msg) {
            var data = JSON.parse(msg.data);
            if (Methods.hasOwnProperty(data.method)) {
                Methods[data.method](data.body)
            } else {
                console.log('Вызванный метод ' + data.method + ' - не реализован в текущей версии.')
            }
        };
        ws.push = function(method, data){
            if (ws) {
                ws.send(JSON.stringify({method: method, body: data}))
            } else {
                console.log('Невозможно отправить - отсутствует соединение')
            }
        };
        ws.onclose = function(event) {
            ws = null;
            if (event.wasClean) {
            } else {
                if(!ws_timer) {
                    console.log('Обрыв соединения ws. Код: ' + event.code);
                    ws_timer = setInterval(ws_connect, 5000);
                    console.log('Через 5 секунд будет попытка восстановить соединение - не надо тут ничего рефрешить. Само отрефрешится.');
                }
            }
        };
    }

    function set_cookie(name, value, days) {
        var expires = '';
        if (days) {
            var date = new Date();
            date.setTime(date.getTime()+(days*24*60*60*1000));
            expires = '; expires='+date.toGMTString();
        }
        document.cookie = name+'='+encodeURI(value)+expires+'; path=/';
    }

    function get_cookie(name) {
        name = name + '=';
        var cooks = document.cookie.split(';');
        for(var i=0;i < cooks.length;i++) {
            var c = cooks[i];
            while (c.charAt(0)==' ') c = c.substring(1,c.length);
            if (c.indexOf(name) == 0) return decodeURI(c.substring(name.length,c.length));
        }
        return false;
    }

    function erase_cookie(name) {
        set_cookie(name, '', -1);
    }

    $('document').ready(function(){
        ws_connect();
        if (get_cookie('token')){
            // залогинен
        } else {
            // показать формочку логина/регистрации
        }
        $('#send').on('click', function(){
            ws.push('send_msg', {text: $('#text').val()});
        });

        $('#auth').on('click', function(){
            ws.push('auth', {login: $('#login').val(), pass: $('#pass').val()});
        });

        $('#reg').on('click', function(){
            ws.push('reg', {login: $('#login').val(), pass: $('#pass').val(), name: $('#name').val()});
        });

        $('#logout').on('click', function(){
            erase_cookie('token');
            location.reload()
        });
    });

</script>
</body>
</html>